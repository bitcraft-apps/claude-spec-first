name: Test Installation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-install:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Test installation script
      run: |
        echo "Testing installation process..."
        chmod +x scripts/install.sh
        
        # Create a temporary home directory for testing
        export TEST_HOME=$(mktemp -d)
        export HOME=$TEST_HOME
        
        # Run installation
        ./scripts/install.sh
        
        # Verify installation
        echo "Verifying installation..."
        test -d "$HOME/.claude" && echo "‚úÖ .claude directory created" || (echo "‚ùå .claude directory missing" && exit 1)
        test -d "$HOME/.claude/agents" && echo "‚úÖ agents directory created" || (echo "‚ùå agents directory missing" && exit 1)
        test -d "$HOME/.claude/commands" && echo "‚úÖ commands directory created" || (echo "‚ùå commands directory missing" && exit 1)
        test -d "$HOME/.claude/examples" && echo "‚úÖ examples directory created" || (echo "‚ùå examples directory missing" && exit 1)
        
        # Check if files were installed
        agent_count=$(find "$HOME/.claude/agents" -name "*.md" | wc -l)
        command_count=$(find "$HOME/.claude/commands" -name "*.md" | wc -l)
        
        if [ "$agent_count" -eq 5 ]; then
          echo "‚úÖ All 5 agents installed"
        else
          echo "‚ùå Expected 5 agents, found $agent_count"
          exit 1
        fi
        
        if [ "$command_count" -eq 5 ]; then
          echo "‚úÖ All 5 commands installed"  
        else
          echo "‚ùå Expected 5 commands, found $command_count"
          exit 1
        fi
        
        # Test validation script
        if [ -x "$HOME/.claude/validate-framework.sh" ]; then
          echo "‚úÖ Validation script installed and executable"
          cd "$HOME/.claude" && ./validate-framework.sh
        else
          echo "‚ùå Validation script not installed or not executable"
          exit 1
        fi
        
        echo "üéâ Installation test completed successfully!"
        
        # Explicitly clean up the temporary home directory
        echo "üßπ Cleaning up test environment..."
        rm -rf "$TEST_HOME"
        echo "‚úÖ Cleanup completed"